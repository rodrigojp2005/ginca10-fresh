let g,d,r,m,c=1e3,f=5,T=1,h=!0,l=[];const B=[{lat:-12.9714,lng:-38.5014,name:"Salvador, BA"}];window.initGame=function(){l=window.gameLocations&&window.gameLocations.length>0?window.gameLocations:B,console.log("Locais carregados:",l),!localStorage.getItem("gincaneiros_tutorial_seen")||window.location.search.includes("tutorial=1")?(localStorage.setItem("gincaneiros_tutorial_seen","true"),R().then(()=>{M()})):M()};function M(){I(),P(),N(),O()}function I(){g=new google.maps.Map(document.getElementById("map"),{zoom:4,center:{lat:-14.235,lng:-51.9253},mapTypeId:"roadmap",zoomControl:!0,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,rotateControl:!1,scaleControl:!1,panControl:!1,navigationControl:!1,gestureHandling:"greedy"}),g.addListener("click",function(t){h&&(m={lat:t.latLng.lat(),lng:t.latLng.lng()},window.userMarker&&window.userMarker.setMap(null),window.userMarker=new google.maps.Marker({position:m,map:g,title:"Seu palpite",icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}),w(!0))})}function P(){let e=y(),o={lat:e.lat-25e-5,lng:e.lng};function n(a,s){const u=s.lng-a.lng,p=s.lat-a.lat;return(Math.atan2(u,p)*180/Math.PI+360)%360}const i=n(o,e);d=new google.maps.StreetViewPanorama(document.getElementById("streetview"),{position:o,pov:{heading:i,pitch:0},zoom:1,disableDefaultUI:!0,showRoadLabels:!1,motionTracking:!1}),window.characterMarker&&window.characterMarker.setMap(null),window.characterMarker=new google.maps.Marker({position:e,map:d,icon:{url:"https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExeTRweGJoMHk1eG5nb2tyOHMyMHp1ZGlpYTFoZDZ6Ym9zZ3ZkYXB2MSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/bvQHYGOF8UOXqXSFir/giphy.gif",scaledSize:new google.maps.Size(60,80),anchor:new google.maps.Point(30,80)},visible:!0}),window.characterMarker.addListener("click",function(){W(r)}),d.addListener("status_changed",function(){if(d.getStatus()!=="OK"){console.warn("Street View n√£o dispon√≠vel para esta localiza√ß√£o, tentando outra...");const a=y();d.setPosition(a),window.characterMarker&&window.characterMarker.setPosition(a)}})}function y(){let t=[];l&&l.length>0&&(t=l.filter(o=>!o.no_gincana)),t.length===0&&(t=B);const e=t[Math.floor(Math.random()*t.length)];return console.log("Localiza√ß√£o selecionada:",e.name||"Local aleat√≥rio"),{lat:e.lat,lng:e.lng}}function N(){document.getElementById("showMapBtn").addEventListener("click",G),document.getElementById("closeMapBtn").addEventListener("click",b);const t=document.getElementById("cancelGuessBtn");t&&t.addEventListener("click",b),document.getElementById("confirmGuessBtn").addEventListener("click",Y),document.getElementById("continueBtn").addEventListener("click",k),document.getElementById("overlay").addEventListener("click",k)}function O(){if(l.length===0){console.error("Nenhum local dispon√≠vel para o jogo");return}r=l[Math.floor(Math.random()*l.length)],console.log("Local atual:",r),setTimeout(()=>{let e={lat:r.lat,lng:r.lng},o={lat:e.lat-25e-5,lng:e.lng};function n(a,s){const u=s.lng-a.lng,p=s.lat-a.lat;return(Math.atan2(u,p)*180/Math.PI+360)%360}const i=n(o,e);d.setPosition(o),d.setPov({heading:i,pitch:0}),window.characterMarker&&window.characterMarker.setPosition(e)},500),window.userMarker&&window.userMarker.setMap(null),window.correctMarker&&window.correctMarker.setMap(null),m=null,h=!0,E(),w(!1)}function w(t){const e=document.getElementById("confirmGuessBtn"),o=document.getElementById("mapInstructions");!e||!o||(t?(e.disabled=!1,e.classList.add("has-guess"),e.textContent="üéØ Confirmar Palpite",o.classList.add("hidden")):(e.disabled=!0,e.classList.remove("has-guess"),e.textContent="üéØ Clique no mapa primeiro",o.classList.remove("hidden")))}function G(){document.getElementById("mapSlider").classList.add("active"),w(!!m)}function b(){document.getElementById("mapSlider").classList.remove("active")}function v(){document.getElementById("mapSlider").classList.remove("active")}function Y(){if(!m){Swal.fire({icon:"warning",title:"Aten√ß√£o!",text:"Por favor, clique no mapa para fazer seu palpite!",confirmButtonColor:"#007bff"});return}const t=j(r,m);f--;let e=`Voc√™ est√° √† ${t.toFixed(2)} km do local, `,o="Siga nessa dire√ß√£o ...",n="info";if(t<=10)o="Parab√©ns! üéâ",n="success",e+=`

Voc√™ acertou! A localiza√ß√£o era: ${r.name}`,e+=`

Pontua√ß√£o final: ${c} pontos`,C(c,r),x(),Swal.fire({icon:n,title:o,text:e,confirmButtonText:"Novo Jogo",confirmButtonColor:"#007bff",allowOutsideClick:!1}).then(i=>{i.isConfirmed&&(v(),location.reload())});else if(c=Math.max(0,c-200),n="error",f>0){const i=z(r,m);let a="";switch(i){case"Norte":a="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGt2MXQzdmY3eHFrYzNkcjNmcnhhbWl5emlzYjNibnR5ZmEwc2locyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/7aFMOMlY5HgQnCcK5n/giphy.gif";break;case"Sul":a="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeWwxbW12a2ExZTByd2x4aGxxdjhrbjJxdmJhZDJkZ2x3aW12czY2aiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/jfxNsKqJLIc3Kw1nZz/giphy.gif";break;case"Leste":a="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExZmlwZXAydHE4cmszOHlpdDBudnd4OTd6cW4ybjhrODVzMW5tMGQxZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/A0Mmm3WcsQVrMlYjlY/giphy.gif";break;case"Oeste":a="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeWd5aW5nbnpreWNlcXh6MHk1aDVtMWJkdTJoOW15bm1ycHcwb2swciZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/CGTFfpxHMpxCJk1eGR/giphy.gif";break}e+=`

 v√° mais para o ${i}.`,e+=`

 Falta(m) ${f} tentativa(s).`,e+=`

 Pontua√ß√£o atual: ${c} pts.`,Swal.fire({title:o,text:e.replace(/\n/g," "),imageUrl:a,imageWidth:150,imageHeight:150,imageAlt:i,confirmButtonColor:"#007bff",confirmButtonText:"Continuar",allowOutsideClick:!1})}else o="Fim de Jogo",e+=`

Suas tentativas acabaram!`,e+=`

A localiza√ß√£o era: ${r.name}`,e+=`

Pontua√ß√£o final: ${c} pontos`,C(c,r),x(),Swal.fire({icon:n,title:o,text:e,confirmButtonText:"Novo Jogo",confirmButtonColor:"#007bff",allowOutsideClick:!1}).then(i=>{i.isConfirmed&&(v(),location.reload())});E()}function j(t,e){const n=(e.lat-t.lat)*Math.PI/180,i=(e.lng-t.lng)*Math.PI/180,a=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t.lat*Math.PI/180)*Math.cos(e.lat*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function z(t,e){const o=t.lat-e.lat,n=t.lng-e.lng;return Math.abs(o)>Math.abs(n)?o>0?"Norte":"Sul":n>0?"Leste":"Oeste"}function x(t){h=!1,window.correctMarker=new google.maps.Marker({position:r,map:g,title:"Localiza√ß√£o correta",icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"})}window.showHelpMessage=function(){const t=["Ajude-me a encontrar onde estou no mapa! üó∫Ô∏è","Estou perdido! Voc√™ pode me ajudar a descobrir minha localiza√ß√£o? ü§î","Olhe ao redor e tente descobrir onde estou! üîç","Use as pistas visuais para me encontrar no mapa! üëÄ","Preciso da sua ajuda para descobrir onde estou! üÜò"],e=t[Math.floor(Math.random()*t.length)];Swal.fire({icon:"question",title:"Preciso de Ajuda! ü§î",text:e,confirmButtonText:"Vou te ajudar!",confirmButtonColor:"#28a745",background:"#fff",iconColor:"#ffc107"})};function k(){console.log("hidePopup chamada")}function E(){document.getElementById("score").textContent=c,document.getElementById("attempts").textContent=f,document.getElementById("round").textContent=T}window.addEventListener("load",()=>{const t=window.gameLocations||[];if(t.length===1&&t[0].no_gincana){D();return}const e=setInterval(()=>{typeof google<"u"&&typeof google.maps<"u"&&(clearInterval(e),window.gm_authFailure=function(){console.error("Falha na autentica√ß√£o da Google Maps API"),Swal.fire({icon:"error",title:"Erro na API do Google Maps",text:"Problema de autentica√ß√£o ou limite de requisi√ß√µes. Tente novamente em alguns minutos.",confirmButtonColor:"#d33"})},initGame())},100)});async function C(t,e){try{const o=document.querySelector('meta[name="csrf-token"]');if(!o){console.log("Usu√°rio n√£o logado - pontua√ß√£o n√£o ser√° salva");return}const i=await(await fetch("/game/save-score",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o.getAttribute("content"),Accept:"application/json"},body:JSON.stringify({gincana_id:e.gincana_id||null,pontuacao:t,tempo_total_segundos:null,locais_visitados:1,latitude:e.lat,longitude:e.lng})})).json();i.success?console.log("Pontua√ß√£o salva com sucesso!",i):console.error("Erro ao salvar pontua√ß√£o:",i)}catch(o){console.error("Erro na requisi√ß√£o para salvar pontua√ß√£o:",o)}}function D(){const t=document.querySelector(".game-container");t&&(t.style.display="none"),window.isAuthenticated||!1?Swal.fire({title:"üéØ Nenhuma Gincana Dispon√≠vel",text:"N√£o h√° gincanas p√∫blicas criadas ainda. Que tal ser o primeiro a criar uma?",icon:"info",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#6c757d",confirmButtonText:"üéÆ Criar Minha Gincana",cancelButtonText:"Cancelar",background:"#fff",allowOutsideClick:!1,backdrop:`
                rgba(0,0,123,0.4)
                left top
                no-repeat
            `}).then(o=>{o.isConfirmed?window.location.href="/gincana/create":t&&(t.style.display="block")}):Swal.fire({title:"üéØ Nenhuma Gincana Dispon√≠vel",text:"N√£o h√° gincanas p√∫blicas criadas ainda. Fa√ßa login para criar sua pr√≥pria gincana!",icon:"info",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#6c757d",confirmButtonText:"üîê Fazer Login",cancelButtonText:"Ok",background:"#fff",allowOutsideClick:!1,backdrop:`
                rgba(0,0,123,0.4)
                left top
                no-repeat
            `}).then(o=>{o.isConfirmed?window.location.href="/login":t&&(t.style.display="block")})}function R(){return Swal.fire({title:"Vc √© bom de investiga√ß√£o?",text:" Vamos testar suas habilidades e ver se voc√™ consegue indentificar este local! üïµÔ∏è‚Äç‚ôÇÔ∏è",imageUrl:"https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExOG4wcTBrN2hpaDlhaGl0MHVnNDk5ZGo3ODNsa3V2YzI5c3R1aWdsNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l378tV67u1QQkSqFq/giphy.gif",imageWidth:400,imageHeight:200,imageAlt:"Custom image",confirmButtonText:"Vamos l√°! üöÄ"})}function W(t){const e=window.isAuthenticated||!1;Swal.fire({title:t.name||"Local Misterioso",html:`
            <div class="post-content" style="text-align: left;">
                <div class="post-inicial" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">üìç Dica do Local:</h4>
                    <p style="margin: 0; color: #6c757d; font-style: italic;">"${t.contexto||"Descubra onde estou!"}"</p>
                </div>
                
                <div class="comments-section">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üí¨ Coment√°rios da Comunidade</h4>
                    <div id="comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <div style="text-align: center; color: #6c757d;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando coment√°rios...
                        </div>
                    </div>
                    
                    ${e?`
                        <div class="add-comment" style="border-top: 1px solid #dee2e6; padding-top: 15px;">
                            <textarea id="new-comment" placeholder="Compartilhe sua experi√™ncia sobre este local..." 
                                style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical; font-family: inherit;"></textarea>
                            <button onclick="addComment(${t.gincana_id||t.id})" 
                                style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üí¨ Comentar
                            </button>
                        </div>
                    `:`
                        <div style="text-align: center; padding: 15px; background: #e9ecef; border-radius: 4px;">
                            <p style="margin: 0; color: #6c757d;">
                                üîê Fa√ßa login  para comentar e interagir com a comunidade!
                            </p>
                        </div>
                    `}
                </div>
            </div>
        `,width:600,showCloseButton:!0,showConfirmButton:!1,didOpen:()=>{window.isAuthenticated&&L(t.gincana_id||t.id)}})}async function L(t){try{console.log("Carregando coment√°rios para gincana_id:",t);const e=await fetch(`/comentarios/${t}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const o=await e.text();console.log("Resposta do servidor:",o.substring(0,500));let n;try{n=JSON.parse(o)}catch(a){throw console.error("Erro ao parsear JSON:",a),console.error("Resposta completa:",o),new Error("Resposta n√£o √© um JSON v√°lido")}const i=document.getElementById("comments-list");if(!i)return;if(n.length===0){i.innerHTML=`
                <div style="text-align: center; color: #6c757d; padding: 20px;">
                    ü§î Seja o primeiro a comentar sobre este local!
                </div>
            `;return}i.innerHTML=n.map(a=>`
            <div class="comment" style="border-bottom: 1px solid #eee; padding: 12px 0;">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <strong style="color: #495057; font-size: 14px;">${a.user.name}</strong>
                    <small style="color: #6c757d; margin-left: 10px;">${Z(a.created_at)}</small>
                </div>
                <p style="margin: 0; color: #495057; line-height: 1.4; font-size: 14px;">${a.conteudo}</p>
            </div>
        `).join("")}catch(e){console.error("Erro ao carregar coment√°rios:",e),document.getElementById("comments-list").innerHTML=`
            <div style="text-align: center; color: #dc3545;">
                ‚ùå Erro ao carregar coment√°rios: ${e.message}
            </div>
        `}}window.addComment=async function(t){const e=document.getElementById("new-comment"),o=e.value.trim();if(!o){Swal.fire({icon:"warning",title:"Aten√ß√£o",text:"Digite seu coment√°rio primeiro!",confirmButtonColor:"#007bff"});return}try{console.log("Enviando coment√°rio para gincana_id:",t);const n=document.querySelector('meta[name="csrf-token"]'),i=await fetch("/comentarios",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n.getAttribute("content"),Accept:"application/json"},body:JSON.stringify({gincana_id:t,conteudo:o})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=await i.text();console.log("Resposta do servidor (coment√°rio):",a.substring(0,500));let s;try{s=JSON.parse(a)}catch(u){throw console.error("Erro ao parsear JSON:",u),console.error("Resposta completa:",a),new Error("Resposta n√£o √© um JSON v√°lido")}if(s.success)e.value="",L(t),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Coment√°rio adicionado!",showConfirmButton:!1,timer:2e3});else throw new Error(s.message||"Erro ao adicionar coment√°rio")}catch(n){console.error("Erro ao adicionar coment√°rio:",n),Swal.fire({icon:"error",title:"Erro",text:`N√£o foi poss√≠vel adicionar seu coment√°rio: ${n.message}`,confirmButtonColor:"#dc3545"})}};function Z(t){const e=new Date(t),n=(new Date-e)/(1e3*60*60);return n<1?"Agora mesmo":n<24?`${Math.floor(n)}h atr√°s`:e.toLocaleDateString("pt-BR")}
